#!/usr/bin/env ruby

require 'jiragit'

log = Jiragit::Logger.new(".git/jiragit/hooks.log")
log.hook = File.basename $0
log.info "launched"

STDIN.reopen('/dev/tty')

def previous_head
  ARGV[0]
end

def new_head
  ARGV[1]
end

def branch_switch?
  ARGV[2] == '1'
end

def current_branch
  `git symbolic-ref -q HEAD --short`.chomp
end

def query(message)
  print "#{message} > "
  STDIN.gets.chomp
end

def quit_if_detached_head
  exit(1) unless current_branch!=''
end

def jira_store
  @jira_store ||= Jiragit::JiraStore.new(".git/jiragit/jira_store")
end
#quit_if_detached_head


relations = jira_store.relations(branch: current_branch).to_a
types = relations.map{ |r| r.type }

if !types.include?(:jira)
  jira = query("Is there a JIRA Number?")
  jira_store.relate(jira: jira, branch: current_branch) unless jira.empty?
end




